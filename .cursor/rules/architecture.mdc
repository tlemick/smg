---
description: Comprehensive Site Architecture - The Master Blueprint
globs: **/*.{ts,tsx}
alwaysApply: true
---

# Stock Market Game - Site Architecture

## Overview

This is a **Next.js 15 App Router** application with a **PostgreSQL + Prisma** backend, implementing a financial trading simulation platform with real-time market data integration.

## Technology Stack

### Core Framework
- **Next.js 15.3.1** - App Router (RSC & Server Actions)
- **React 19** - UI framework
- **TypeScript 5** - Type safety

### Backend & Database
- **Prisma 6.7** - ORM
- **PostgreSQL** - Primary database
- **yahoo-finance2 v3.11** - Market data provider

### UI & Styling
- **Tailwind CSS 4** - Utility-first styling
- **Radix UI** - Accessible component primitives
- **Lucide React** - Icon system
- **Phosphor Icons** - Supplementary icons
- **Recharts 3** - Data visualization

### Financial Precision
- **Decimal.js** - Precision math for financial calculations
- Custom `FinancialMath` service - Wraps all arithmetic

### Authentication & Security
- **Cookie-based sessions** - HttpOnly cookies
- **bcryptjs** - Password hashing (for production; demo uses plaintext)
- **jsonwebtoken** - JWT tokens (if needed for API auth)

### State Management
- **React Context** - Global state (User, Theme, Toast)
- **Custom Hooks** - Feature-specific state & data fetching
- **Server State** - API routes return fresh data on each request

---

## Project Structure

```
/Users/londinium/Code/smg_front/
├── .cursor/
│   └── rules/                        # Architecture & coding standards
│       ├── architecture.mdc          # This file (master blueprint)
│       ├── component-patterns.mdc    # Component rules
│       ├── data.mdc                  # Data fetching & API
│       ├── financial-math.mdc        # Financial calculation standards
│       ├── service-layer.mdc         # Service architecture
│       └── ui.mdc                    # UI patterns
│
├── prisma/
│   ├── schema.prisma                 # Database schema
│   ├── migrations/                   # Database migrations
│   ├── client.ts                     # Prisma client singleton
│   └── seed.ts                       # Database seeding
│
├── src/
│   ├── app/                          # Next.js App Router
│   │   ├── layout.tsx                # Root layout (providers, fonts, metadata)
│   │   ├── page.tsx                  # Landing page (login)
│   │   │
│   │   ├── api/                      # Backend API Routes
│   │   │   ├── admin/                # Admin endpoints (user/session management)
│   │   │   ├── user/                 # User endpoints (profile, portfolio, auth)
│   │   │   ├── trade/                # Trading endpoints (orders, execution)
│   │   │   ├── watchlist/            # Watchlist CRUD
│   │   │   ├── quote/                # Real-time stock quotes
│   │   │   ├── search/               # Asset search
│   │   │   ├── chart/                # Chart data
│   │   │   └── asset-detail/         # Asset fundamentals
│   │   │
│   │   ├── dashboard/                # Main dashboard (protected route)
│   │   │   ├── layout.tsx            # Dashboard layout (sidebar, nav)
│   │   │   ├── page.tsx              # Dashboard home
│   │   │   ├── portfolio/            # Portfolio views
│   │   │   └── [ticker]/             # Asset detail pages
│   │   │
│   │   ├── onboarding/               # New user onboarding flow
│   │   ├── leaderboard/              # User rankings
│   │   ├── settings/                 # User settings
│   │   ├── admin/                    # Admin panel (protected)
│   │   └── trade/                    # Trading modals/pages
│   │
│   ├── components/                   # React components (organized by feature)
│   │   ├── admin/                    # Admin-specific components
│   │   ├── asset/                    # Asset detail components
│   │   ├── dashboard/                # Dashboard feature components
│   │   ├── layout/                   # Layout components (nav, footer)
│   │   ├── navigation/               # Navigation (sidebar, mobile nav, cmd palette)
│   │   ├── onboarding/               # Onboarding flow components
│   │   ├── portfolio/                # Portfolio visualization components
│   │   ├── trading/                  # Trading modals & forms
│   │   ├── ui/                       # Reusable UI primitives
│   │   └── watchlist/                # Watchlist components
│   │
│   ├── context/                      # React Context providers
│   │   ├── UserContext.tsx           # Auth & user state
│   │   ├── ThemeContext.tsx          # Dark/light mode
│   │   └── ToastContext.tsx          # Global notifications
│   │
│   ├── hooks/                        # Custom React hooks
│   │   ├── useUser.ts                # User auth hook
│   │   ├── usePortfolioOverview.ts   # Portfolio data
│   │   ├── useStockApi.ts            # Stock quotes
│   │   ├── useWatchlists.ts          # Watchlist data
│   │   └── [other feature hooks]
│   │
│   ├── lib/                          # Services, utilities, business logic
│   │   ├── api/                      # API client layer
│   │   │   ├── api-client.ts         # Centralized fetch wrapper
│   │   │   └── index.ts              # Barrel export
│   │   │
│   │   ├── financial/                # Financial services
│   │   │   ├── financial-math.ts     # Decimal.js wrapper
│   │   │   ├── formatters.ts         # Currency, %, number formatting
│   │   │   ├── calculators.ts        # ROI, P&L, portfolio metrics
│   │   │   └── index.ts              # Barrel export
│   │   │
│   │   ├── formatters.ts             # General formatters (legacy, migrate to financial/)
│   │   ├── utils.ts                  # General utilities (cn, etc.)
│   │   ├── yahoo-finance-service.ts  # Yahoo Finance API wrapper
│   │   ├── order-execution-service.ts# Order processing & execution
│   │   ├── market-state-service.ts   # Market hours detection
│   │   ├── cash-management-service.ts# Cash balance management
│   │   ├── risk-metrics-service.ts   # Portfolio risk calculations
│   │   └── [other services]
│   │
│   ├── types/                        # TypeScript type definitions
│   │   ├── index.ts                  # Shared types (Asset, Portfolio, etc.)
│   │   └── toast.ts                  # Toast notification types
│   │
│   └── scripts/                      # Utility scripts (admin tools)
│
├── public/                           # Static assets
│   ├── avatars/                      # User avatars
│   ├── bgs/                          # Background images
│   ├── onboarding_images/            # Onboarding visuals
│   └── [other static files]
│
├── docs/                             # Documentation
│   ├── engineering-guide.md          # Developer guide
│   ├── architecture.md               # Architecture decisions
│   ├── trading-implementation-plan.md# Trading system design
│   └── [other docs]
│
├── tests/                            # Test files
│   ├── financial-math.test.ts        # Financial math unit tests
│   └── [other tests]
│
├── scripts/                          # Node scripts (DB seeding, etc.)
│   ├── seed-demo-investors.ts        # Seed demo users
│   └── update-asset-logos.ts         # Asset logo updates
│
├── package.json                      # Dependencies & scripts
├── tsconfig.json                     # TypeScript configuration
├── next.config.ts                    # Next.js configuration
├── tailwind.config.ts                # Tailwind configuration
├── components.json                   # shadcn/ui config
└── .env.local                        # Environment variables (gitignored)
```

---

## Architectural Layers

### Layer 1: Database (PostgreSQL + Prisma)
**Purpose:** Data persistence

**Key Models:**
- `User` - User accounts & authentication
- `GameSession` - Trading game sessions (time-bound competitions)
- `Portfolio` - User portfolios (one per user per session)
- `Holding` - Asset positions (ticker, shares, cost basis)
- `Transaction` - Trade history
- `Order` - Open orders (market & limit)
- `LimitOrder` - Pending limit orders
- `Watchlist` - User watchlists
- `UserActivity` - Activity feed events
- `PortfolioPerformance` - Historical performance snapshots

**Access Pattern:**
```typescript
// ONLY accessed from API routes (src/app/api/**/route.ts)
import { prisma } from '../../../../../prisma/client';

export async function GET(request: NextRequest) {
  const user = await prisma.user.findUnique({ where: { id } });
  // ...
}
```

**Rules:**
- ❌ NEVER import Prisma in components, hooks, or client-side code
- ✅ ALWAYS use Prisma in API routes only
- ✅ Use transactions for multi-step operations
- ✅ Index frequently queried fields

---

### Layer 2: API Routes (Next.js Backend)
**Purpose:** Backend business logic, data transformation, external API calls

**Location:** `src/app/api/`

**Pattern:**
```typescript
// src/app/api/user/portfolio/overview/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/prisma/client';
import { getAuthenticatedUser } from '@/lib/auth-helpers'; // Hypothetical

export async function GET(request: NextRequest) {
  // 1. Authenticate
  const user = await getAuthenticatedUser(request);
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 2. Fetch data
  const portfolio = await prisma.portfolio.findFirst({
    where: { userId: user.id },
    include: { holdings: true }
  });

  // 3. Transform & return
  return NextResponse.json({
    totalValue: portfolio.totalValue,
    cash: portfolio.cash_balance,
    holdings: portfolio.holdings.map(h => ({
      ticker: h.ticker,
      shares: h.shares,
      costBasis: h.costBasis
    }))
  });
}
```

**Conventions:**
- **File naming:** `route.ts` (Next.js convention)
- **Exports:** Named HTTP method functions: `GET`, `POST`, `PUT`, `PATCH`, `DELETE`
- **Error handling:** Always return appropriate HTTP status codes
- **Authentication:** Check user session at the top of every protected route
- **Authorization:** Verify user permissions (e.g., admin role)
- **Response format:** Consistent JSON structure
  ```typescript
  // Success
  { success: true, data: {...} }
  
  // Error
  { success: false, error: 'Message' }
  ```

**Route Organization:**
```
/api/
├── user/               # User-scoped endpoints
│   ├── me/             # GET - Current user
│   ├── login/          # POST - Login
│   ├── logout/         # POST - Logout
│   ├── portfolio/      # Portfolio endpoints
│   │   ├── overview/   # GET - Portfolio summary
│   │   ├── holdings/   # GET - All holdings
│   │   └── performance-series/ # GET - Historical performance
│   └── complete-onboarding/ # PATCH - Complete onboarding
│
├── trade/              # Trading endpoints
│   ├── market-order/   # POST - Execute market order
│   ├── limit-order/    # POST - Place limit order
│   ├── orders/         # GET - Get all orders
│   └── process-orders/ # POST - Background job to execute pending orders
│
├── watchlist/          # Watchlist CRUD
│   ├── route.ts        # GET (all), POST (create)
│   └── [id]/           # GET, PUT, DELETE (specific watchlist)
│
├── admin/              # Admin-only endpoints
│   ├── users/          # User management
│   ├── game-sessions/  # Game session management
│   └── setup-trading/  # Trading system setup
│
├── quote/              # GET - Stock quotes
├── search/             # GET - Asset search
├── chart/              # GET - Chart data
└── asset-detail/       # GET - Asset fundamentals
```

**Authentication Pattern:**
```typescript
// Cookie-based session
import { cookies } from 'next/headers';

async function getAuthenticatedUser(): Promise<User | null> {
  const cookieStore = await cookies();
  const sessionCookie = cookieStore.get('user_session');
  
  if (!sessionCookie) return null;
  
  const sessionData = JSON.parse(sessionCookie.value);
  return sessionData;
}

// Usage in route
export async function GET(request: NextRequest) {
  const user = await getAuthenticatedUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  // ... protected logic
}
```

**Authorization Pattern:**
```typescript
function requireAdmin(user: any): boolean {
  return user.role === 'ADMIN';
}

export async function DELETE(request: NextRequest) {
  const user = await getAuthenticatedUser();
  if (!user || !requireAdmin(user)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  // ... admin-only logic
}
```

---

### Layer 3: API Client (Frontend HTTP Layer)
**Purpose:** Centralized HTTP communication from frontend to backend

**Location:** `src/lib/api/api-client.ts`

**Pattern:**
```typescript
// All hooks use ApiClient, never raw fetch()
import { ApiClient } from '@/lib/api';

export function usePortfolioOverview() {
  const [data, setData] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchData() {
      try {
        const response = await ApiClient.get('/api/user/portfolio/overview');
        setData(response.data);
      } catch (err) {
        setError(err.message);
      } finally {
        setIsLoading(false);
      }
    }
    fetchData();
  }, []);

  return { data, isLoading, error };
}
```

**Rules:**
- ✅ All hooks use `ApiClient` for HTTP requests
- ❌ NEVER use raw `fetch()` in hooks or components
- ✅ ApiClient handles retries, error handling, and request/response interceptors

---

### Layer 4: Custom Hooks (Data Fetching & State Management)
**Purpose:** Encapsulate data fetching, side effects, and local state

**Location:** `src/hooks/`

**Pattern:**
```typescript
// src/hooks/usePortfolioOverview.ts
export function usePortfolioOverview() {
  const [data, setData] = useState<PortfolioOverview | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchPortfolio() {
      try {
        setIsLoading(true);
        const response = await ApiClient.get('/api/user/portfolio/overview');
        
        // Transform & format data using services
        const formatted = {
          ...response.data,
          formattedTotalValue: Formatters.currency(response.data.totalValue),
          formattedCash: Formatters.currency(response.data.cash),
        };
        
        setData(formatted);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Failed to fetch portfolio');
      } finally {
        setIsLoading(false);
      }
    }
    
    fetchPortfolio();
  }, []);

  return { data, isLoading, error };
}
```

**Naming Convention:**
- `use[Feature][Action].ts` - e.g., `usePortfolioOverview.ts`
- Data fetching hooks: `use[Resource].ts` - e.g., `useWatchlists.ts`
- Mutation hooks: `use[Resource]Mutations.ts` - e.g., `useWatchlistMutations.ts`

**Return Signature (MUST BE CONSISTENT):**
```typescript
return { 
  data,           // The fetched/computed data
  isLoading,      // Loading state (ALWAYS 'isLoading', not 'loading')
  error,          // Error message (string | null)
  refetch?,       // Optional: Function to refetch data
  [actions]?      // Optional: Mutation functions (createWatchlist, deleteWatchlist)
};
```

**Rules:**
- ✅ Hooks call services for transformations/calculations
- ✅ Hooks format data before returning to components
- ✅ Always return `{ data, isLoading, error }`
- ❌ Hooks NEVER perform calculations inline (use services)
- ❌ Hooks NEVER import Prisma
- ❌ Hooks NEVER contain JSX

---

### Layer 5: Services (Business Logic)
**Purpose:** Pure business logic, calculations, formatting, validation

**Location:** `src/lib/`

**Key Services:**
- **`financial/financial-math.ts`** - Precision arithmetic (Decimal.js wrapper)
- **`financial/formatters.ts`** - Display formatting (currency, %, numbers)
- **`financial/calculators.ts`** - Financial calculations (ROI, P&L)
- **`api/api-client.ts`** - HTTP communication
- **`yahoo-finance-service.ts`** - Yahoo Finance API wrapper
- **`order-execution-service.ts`** - Order processing logic
- **`market-state-service.ts`** - Market hours detection
- **`cash-management-service.ts`** - Cash balance operations
- **`risk-metrics-service.ts`** - Portfolio risk calculations

**Pattern:**
```typescript
// src/lib/financial/calculators.ts
import { FinancialMath } from './financial-math';

export class FinancialCalculators {
  /**
   * Calculate unrealized P&L for a holding
   */
  static calculateUnrealizedPnL(
    currentPrice: number,
    costBasis: number,
    shares: number
  ): { pnl: number; pnlPercent: number } {
    const currentValue = FinancialMath.multiply(currentPrice, shares);
    const totalCost = FinancialMath.multiply(costBasis, shares);
    const pnl = FinancialMath.subtract(currentValue, totalCost);
    const pnlPercent = FinancialMath.divide(pnl, totalCost);
    
    return {
      pnl: pnl.toNumber(),
      pnlPercent: pnlPercent.toNumber()
    };
  }
}
```

**Rules:**
- ✅ Services are pure functions or static class methods
- ✅ Services are unit testable without mocking
- ❌ Services NEVER import React hooks
- ❌ Services NEVER import components
- ❌ Services NEVER contain JSX

See `.cursor/rules/service-layer.mdc` for complete guide.

---

### Layer 6: React Components (UI Rendering)
**Purpose:** Display data, handle user interaction

**Location:** `src/components/`

**Organization:** Feature-based directory structure
```
components/
├── dashboard/          # Dashboard-specific components
│   ├── PortfolioCard.tsx
│   ├── PortfolioPerformanceChart.tsx
│   ├── TransactionsFeed.tsx
│   └── watchlists/     # Sub-feature (nested)
│       ├── WatchlistsContainer.tsx
│       ├── WatchlistHeader.tsx
│       ├── WatchlistTable.tsx
│       └── index.ts    # Barrel export
│
├── asset/              # Asset detail components
│   ├── AssetHeader.tsx
│   ├── PriceChart.tsx
│   ├── Fundamentals.tsx
│   └── index.ts
│
├── trading/            # Trading modals
│   ├── BuyModal.tsx
│   ├── SellModal.tsx
│   └── OrderConfirmation.tsx
│
├── ui/                 # Reusable UI primitives
│   ├── button.tsx
│   ├── card.tsx
│   ├── input.tsx
│   ├── toast.tsx
│   └── [other primitives]
│
└── [other features]/
```

**Component Categories:**

1. **Page Components** (`src/app/**/page.tsx`)
   - Top-level route components
   - Orchestrate layout & data flow
   - Minimal logic (just layout)

2. **Feature Components** (`src/components/[feature]/`)
   - Call custom hooks for data
   - Handle feature-specific logic
   - Compose smaller components

3. **Presentation Components** (`src/components/ui/`, `src/components/[feature]/`)
   - Pure UI rendering
   - Accept data via props
   - No hooks (except UI-related like `useState` for local UI state)

**Pattern:**
```typescript
// src/components/dashboard/PortfolioCard.tsx
import { usePortfolioOverview } from '@/hooks/usePortfolioOverview';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui';

export function PortfolioCard() {
  // 1. Fetch data via hook
  const { data, isLoading, error } = usePortfolioOverview();
  
  // 2. Handle loading & error states
  if (isLoading) return <CardSkeleton />;
  if (error) return <ErrorMessage error={error} />;
  
  // 3. Display pre-formatted data (NO calculations, NO formatting)
  return (
    <Card>
      <CardHeader>
        <CardTitle>Portfolio Overview</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-2">
          <div>
            <span className="text-sm text-muted-foreground">Total Value</span>
            <p className="text-2xl font-bold">{data.formattedTotalValue}</p>
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Cash</span>
            <p className="text-lg">{data.formattedCash}</p>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Rules:**
- ✅ Components display data (JSX only)
- ✅ Components handle user events (onClick, onChange)
- ✅ Components manage local UI state (modal open/closed, selected tab)
- ❌ Components NEVER call `fetch()` directly
- ❌ Components NEVER perform calculations
- ❌ Components NEVER format values inline
- ❌ Components NEVER define interfaces (use `src/types/`)

See `.cursor/rules/component-patterns.mdc` for complete guide.

---

### Layer 7: Context Providers (Global State)
**Purpose:** App-wide state (auth, theme, notifications)

**Location:** `src/context/`

**Current Providers:**
1. **UserContext** - Authentication & user data
2. **ThemeContext** - Dark/light mode
3. **ToastContext** - Global notifications

**Pattern:**
```typescript
// src/context/UserContext.tsx
'use client';

import { createContext, useContext, useState, useEffect } from 'react';

interface UserContextType {
  user: User | null;
  setUser: (user: User | null) => void;
  isLoading: boolean;
  login: (email: string, password: string) => Promise<{ success: boolean; error?: string }>;
  logout: () => void;
}

const UserContext = createContext<UserContextType | null>(null);

export function UserProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  // Check session on mount
  useEffect(() => {
    checkSession();
  }, []);

  const checkSession = async () => { /* ... */ };
  const login = async (email, password) => { /* ... */ };
  const logout = async () => { /* ... */ };

  return (
    <UserContext.Provider value={{ user, setUser, isLoading, login, logout }}>
      {children}
    </UserContext.Provider>
  );
}

export function useUser() {
  const context = useContext(UserContext);
  if (!context) throw new Error('useUser must be used within a UserProvider');
  return context;
}
```

**Setup in Root Layout:**
```typescript
// src/app/layout.tsx
export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <ThemeProvider>
          <UserProvider>
            <ToastProvider>
              {children}
            </ToastProvider>
          </UserProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}
```

**When to Use Context:**
- ✅ Authentication state (UserContext)
- ✅ Theme preference (ThemeContext)
- ✅ Global notifications (ToastContext)
- ✅ App-wide settings
- ❌ Feature-specific data (use hooks instead)
- ❌ Frequently changing data (causes re-renders)

---

## File Naming Conventions

### Components
- **PascalCase** for component files: `PortfolioCard.tsx`, `BuyModal.tsx`
- **Barrel exports** for sub-directories: `index.ts` exports all components

Example:
```typescript
// src/components/dashboard/watchlists/index.ts
export { WatchlistsContainer } from './WatchlistsContainer';
export { WatchlistHeader } from './WatchlistHeader';
export { WatchlistTable } from './WatchlistTable';
```

### Hooks
- **camelCase** with `use` prefix: `usePortfolioOverview.ts`, `useWatchlists.ts`
- Mutation hooks: `use[Resource]Mutations.ts` (e.g., `useWatchlistMutations.ts`)

### Services
- **kebab-case**: `financial-math.ts`, `order-execution-service.ts`, `yahoo-finance-service.ts`
- Classes: **PascalCase** (e.g., `FinancialMath`, `OrderExecutionService`)

### Types
- **camelCase** for files: `index.ts`, `toast.ts`
- Interfaces: **PascalCase** (e.g., `User`, `Portfolio`, `WatchlistData`)

### API Routes
- **kebab-case** for directories: `src/app/api/user-activity/route.ts`
- Always `route.ts` for the file itself (Next.js convention)

### Pages
- **kebab-case** for directories: `src/app/asset-detail/[ticker]/page.tsx`
- Always `page.tsx` for the file itself
- Always `layout.tsx` for layouts

---

## Import/Export Patterns

### Path Aliases
Always use `@/` for imports from `src/`:
```typescript
// ✅ GOOD
import { usePortfolioOverview } from '@/hooks/usePortfolioOverview';
import { FinancialMath } from '@/lib/financial';
import { Card } from '@/components/ui';

// ❌ BAD - Relative paths
import { usePortfolioOverview } from '../../../hooks/usePortfolioOverview';
```

### Barrel Exports
Use `index.ts` for cleaner imports:
```typescript
// src/lib/financial/index.ts
export { FinancialMath } from './financial-math';
export { Formatters } from './formatters';
export { FinancialCalculators } from './calculators';

// Usage
import { FinancialMath, Formatters } from '@/lib/financial';
```

### Named Exports (Preferred)
```typescript
// ✅ GOOD - Named exports
export function PortfolioCard() { /* ... */ }

// Usage
import { PortfolioCard } from '@/components/dashboard';
```

### Default Exports (Pages & Layouts Only)
```typescript
// ✅ GOOD - Default export for pages
export default function DashboardPage() { /* ... */ }

// Usage (Next.js handles this automatically)
```

### Avoid Circular Dependencies
```typescript
// ❌ BAD
// File A imports File B
// File B imports File A
// This causes build errors

// ✅ GOOD - Extract shared logic to a third file
// File A imports Shared
// File B imports Shared
// Shared has no dependencies on A or B
```

---

## Authentication & Authorization

### Session Management
- **Mechanism:** HttpOnly cookies (`user_session`)
- **Duration:** 7 days
- **Storage:** Cookie contains minimal user data (id, email, name, role)

### Authentication Flow
1. User submits login form (email + password)
2. POST `/api/user/login` validates credentials
3. If valid, set `user_session` cookie
4. Redirect to `/onboarding` (if incomplete) or `/dashboard`
5. On page load, check session via GET `/api/user/me`

### Protected Routes
**Pattern 1: Client-side redirect**
```typescript
// src/app/dashboard/page.tsx
'use client';

import { useUser } from '@/context/UserContext';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

export default function DashboardPage() {
  const { user, isLoading } = useUser();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !user) {
      router.push('/'); // Redirect to login
    }
  }, [user, isLoading, router]);

  if (isLoading) return <LoadingSpinner />;
  if (!user) return null; // Redirect in progress

  return <DashboardContent />;
}
```

**Pattern 2: API route authentication**
```typescript
// src/app/api/user/portfolio/overview/route.ts
import { cookies } from 'next/headers';

async function getAuthenticatedUser() {
  const cookieStore = await cookies();
  const sessionCookie = cookieStore.get('user_session');
  
  if (!sessionCookie) return null;
  
  return JSON.parse(sessionCookie.value);
}

export async function GET(request: NextRequest) {
  const user = await getAuthenticatedUser();
  
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // Fetch user-specific data
  // ...
}
```

### Role-Based Authorization
- **Roles:** `USER`, `ADMIN`
- **Admin routes:** `/admin/*`, `/api/admin/*`

```typescript
function requireAdmin(user: any): boolean {
  return user.role === 'ADMIN';
}

export async function DELETE(request: NextRequest) {
  const user = await getAuthenticatedUser();
  
  if (!user || !requireAdmin(user)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  
  // Admin-only logic
}
```

### Onboarding Flow
1. New user logs in → `hasCompletedOnboarding: false`
2. Redirect to `/onboarding/welcome`
3. Multi-step onboarding (welcome → risk-tolerance → goals → invested-amount)
4. On completion, PATCH `/api/user/complete-onboarding`
5. Set `hasCompletedOnboarding: true`
6. Redirect to `/dashboard`

---

## State Management Philosophy

### When to Use Each Approach

**Context (Global State)**
- User authentication (`UserContext`)
- Theme preference (`ThemeContext`)
- Global notifications (`ToastContext`)
- App-wide settings

**Custom Hooks (Feature State)**
- API data fetching (`usePortfolioOverview`)
- Computed/derived state (`useChartColors`)
- Feature-specific mutations (`useWatchlistMutations`)

**Component State (Local UI State)**
- Modal open/closed
- Form inputs
- Selected tab
- Dropdown expanded

**Server State (API Routes)**
- Database queries (fresh on every request)
- External API calls (Yahoo Finance)
- Background jobs (order execution)

### Example Decision Tree
```
Need state for...
├─ User authentication? → Context (UserContext)
├─ API data? → Custom Hook (usePortfolioOverview)
├─ Modal visibility? → Component State (useState)
├─ Database query? → API Route + Hook
└─ Theme preference? → Context (ThemeContext)
```

---

## Error Handling

### API Routes
Always return structured error responses:
```typescript
export async function POST(request: NextRequest) {
  try {
    // Business logic
    return NextResponse.json({ success: true, data: result });
  } catch (error) {
    console.error('Error:', error);
    return NextResponse.json(
      { success: false, error: 'Descriptive error message' },
      { status: 500 }
    );
  }
}
```

### Custom Hooks
Return error state to components:
```typescript
export function usePortfolioOverview() {
  const [error, setError] = useState<string | null>(null);
  
  useEffect(() => {
    async function fetchData() {
      try {
        const data = await ApiClient.get('/api/user/portfolio/overview');
        setData(data);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Unknown error');
      }
    }
    fetchData();
  }, []);
  
  return { data, isLoading, error };
}
```

### Components
Display errors gracefully:
```typescript
export function PortfolioCard() {
  const { data, isLoading, error } = usePortfolioOverview();
  
  if (error) {
    return (
      <Card>
        <CardContent>
          <p className="text-destructive">Error: {error}</p>
        </CardContent>
      </Card>
    );
  }
  
  // ...
}
```

### Toast Notifications
Use `ToastContext` for user-facing errors:
```typescript
import { useToast } from '@/hooks/useToast';

export function BuyModal() {
  const { showToast } = useToast();
  
  const handleSubmit = async () => {
    try {
      await ApiClient.post('/api/trade/market-order', orderData);
      showToast('Order executed successfully', 'success');
    } catch (error) {
      showToast('Order failed: ' + error.message, 'error');
    }
  };
}
```

---

## Performance Optimization

### React Optimization
- **Memoization:** Use `useMemo` for expensive calculations
  ```typescript
  const chartData = useMemo(() => 
    transformDataForChart(rawData),
    [rawData]
  );
  ```
- **Callbacks:** Use `useCallback` for functions passed as props
  ```typescript
  const handleClick = useCallback(() => {
    doSomething(id);
  }, [id]);
  ```
- **Lazy Loading:** Dynamic imports for heavy components
  ```typescript
  const HeavyChart = dynamic(() => import('@/components/dashboard/HeavyChart'), {
    loading: () => <ChartSkeleton />
  });
  ```

### Next.js Optimization
- **Server Components:** Use RSC for static content (no client JS)
- **Client Components:** Only when interactivity is needed (`'use client'`)
- **Image Optimization:** Use `next/image` for all images
- **Font Optimization:** Use `next/font` (already configured)

### Database Optimization
- **Indexes:** Add indexes to frequently queried fields
- **Pagination:** Limit large result sets
- **Select only needed fields:** Use Prisma `select`
  ```typescript
  const user = await prisma.user.findUnique({
    where: { id },
    select: { id: true, email: true, name: true } // Don't fetch password
  });
  ```

### Caching Strategy
- **Static Assets:** Automatically cached by Next.js
- **API Responses:** Use `stale-while-revalidate` for non-critical data
- **Database Queries:** Cache at the application level for hot paths
- **Yahoo Finance API:** Cache quotes for 1-5 minutes (see `yahoo-finance-service.ts`)

---

## Environment Configuration

### Environment Variables
Create `.env.local` (gitignored) with:
```bash
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/smg_db"

# Order Processing API Key (for background jobs)
ORDER_PROCESSING_API_KEY="your-secure-api-key"

# Node Environment
NODE_ENV="development"
```

### Accessing Environment Variables
**Server-side only (API routes, Server Components):**
```typescript
const dbUrl = process.env.DATABASE_URL;
const apiKey = process.env.ORDER_PROCESSING_API_KEY;
```

**Client-side (components):**
- ❌ Do NOT expose secrets to client
- ✅ Prefix with `NEXT_PUBLIC_` for client-accessible vars
  ```bash
  NEXT_PUBLIC_APP_NAME="Stock Market Game"
  ```
  ```typescript
  const appName = process.env.NEXT_PUBLIC_APP_NAME;
  ```

---

## Testing Strategy

### Current Testing
- **Unit Tests:** `tests/financial-math.test.ts` (Decimal.js precision tests)

### Recommended Testing Approach
1. **Unit Tests** - Services & utilities
   - Test all `lib/` services
   - Focus on financial calculations (critical)
   - Use Jest or Vitest

2. **Integration Tests** - API routes
   - Test API endpoints with mock database
   - Verify auth/authorization
   - Test error cases

3. **E2E Tests** - User flows (future)
   - Test critical paths (login → trade → portfolio)
   - Use Playwright or Cypress

### Testing Commands (add to package.json)
```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage"
  }
}
```

---

## Build & Deployment

### Build Command
```bash
npm run build
```

### Deployment Checklist
- [ ] Environment variables configured in hosting platform
- [ ] Database migrations applied (`npx prisma migrate deploy`)
- [ ] Prisma client generated (`npx prisma generate`)
- [ ] Static assets optimized
- [ ] Build succeeds without errors

### Production Considerations
- **Database:** Use connection pooling (Prisma Accelerate or PgBouncer)
- **Error Tracking:** Add Sentry or similar
- **Monitoring:** Add logging for API routes
- **Rate Limiting:** Add rate limiting to public endpoints
- **HTTPS:** Enforce HTTPS in production (set `secure: true` for cookies)

---

## Development Workflow

### Starting Development
```bash
# Install dependencies
npm install

# Setup database
npx prisma migrate dev
npm run db:seed

# Start dev server
npm run dev
```

### Database Commands
```bash
# Create migration
npx prisma migrate dev --name description

# Reset database (DANGER: Deletes all data)
npm run db:reset

# Seed database
npm run db:seed

# Open Prisma Studio (database GUI)
npx prisma studio
```

### Code Quality
- **Linting:** `npm run lint` (ESLint)
- **Type Checking:** TypeScript checks on build
- **Formatting:** Use Prettier (configure if not already set up)

### Pre-Commit Checklist
- [ ] No `console.log` in production code
- [ ] No inline interfaces in components (move to `src/types/`)
- [ ] No `fetch()` calls in components (use hooks + ApiClient)
- [ ] No calculations or formatting in components (use services)
- [ ] All new hooks return `{ data, isLoading, error }`
- [ ] API routes return structured errors
- [ ] TypeScript errors resolved

---

## Quick Decision Trees

### "Where does this code go?"

**Data Fetching**
```
Need to fetch data from API?
└─ Create custom hook in src/hooks/
   └─ Hook calls ApiClient.get()
   └─ Hook transforms data using services
   └─ Component calls hook
```

**Business Logic / Calculations**
```
Need to calculate something?
└─ Is it financial math? → src/lib/financial/calculators.ts
└─ Is it validation? → src/lib/validation/
└─ Is it formatting? → src/lib/financial/formatters.ts
└─ Other logic? → Create service in src/lib/
```

**UI Component**
```
Creating a new component?
├─ Is it reusable UI? → src/components/ui/
├─ Is it feature-specific? → src/components/[feature]/
└─ Is it a page? → src/app/[route]/page.tsx
```

**API Endpoint**
```
Need a new API endpoint?
└─ Create src/app/api/[route]/route.ts
   ├─ Export GET, POST, PUT, DELETE functions
   ├─ Authenticate user at the top
   ├─ Use Prisma for database queries
   └─ Return structured JSON responses
```

### "What should I import?"

**In Components:**
- ✅ Custom hooks (`@/hooks/`)
- ✅ UI components (`@/components/ui/`)
- ✅ Types (`@/types/`)
- ✅ Context (`@/context/`)
- ✅ Utility functions (`@/lib/utils`)
- ❌ Prisma (backend only)
- ❌ Services (use hooks instead)
- ❌ API routes (call via hooks)

**In Hooks:**
- ✅ ApiClient (`@/lib/api`)
- ✅ Services (`@/lib/`)
- ✅ Types (`@/types/`)
- ❌ Prisma (backend only)
- ❌ Components (hooks don't render)

**In Services:**
- ✅ Other services
- ✅ Types
- ✅ Third-party libraries (Decimal.js, date-fns)
- ❌ React/hooks
- ❌ Components
- ❌ Prisma (use in API routes, not services)

**In API Routes:**
- ✅ Prisma (`@/prisma/client`)
- ✅ Services (`@/lib/`)
- ✅ Types (`@/types/`)
- ✅ Next.js server modules (`next/server`, `next/headers`)
- ❌ React (server-side only)
- ❌ Hooks (server-side only)

---

## Common Patterns & Examples

### Pattern 1: CRUD Operations
**Full Stack Example: Watchlist Management**

1. **Database Schema** (already defined in Prisma)
2. **API Routes** (`src/app/api/watchlist/`)
   - `GET /api/watchlist` - Get all watchlists
   - `POST /api/watchlist` - Create watchlist
   - `DELETE /api/watchlist/[id]` - Delete watchlist
3. **Hook** (`src/hooks/useWatchlists.ts`)
   - Fetches watchlists
   - Returns `{ data, isLoading, error }`
4. **Mutation Hook** (`src/hooks/useWatchlistMutations.ts`)
   - `createWatchlist()`, `deleteWatchlist()`
5. **Component** (`src/components/dashboard/watchlists/WatchlistsContainer.tsx`)
   - Calls hooks
   - Displays data
   - Handles user actions

### Pattern 2: Real-Time Market Data
**Example: Stock Quote Display**

1. **API Route** (`src/app/api/quote/route.ts`)
   - Calls `YahooFinanceService.getQuotes(tickers)`
   - Returns latest prices
2. **Service** (`src/lib/yahoo-finance-service.ts`)
   - Wraps `yahoo-finance2` library
   - Caches quotes for 1 minute
3. **Hook** (`src/hooks/useStockQuote.ts`)
   - Fetches quotes via ApiClient
   - Formats prices using `Formatters.currency()`
4. **Component** (`src/components/asset/AssetPrice.tsx`)
   - Displays formatted price
   - Shows change with color (green/red)

### Pattern 3: Protected Mutations
**Example: Placing a Trade**

1. **Component** (`src/components/trading/BuyModal.tsx`)
   - User submits form
   - Calls mutation function from hook
2. **Hook** (`src/hooks/useTradeExecution.ts`)
   - Validates input
   - Calls API via ApiClient
3. **API Route** (`src/app/api/trade/market-order/route.ts`)
   - Authenticates user
   - Validates order (cash balance, market state)
   - Creates transaction in database
   - Executes order
   - Returns result
4. **Service** (`src/lib/order-execution-service.ts`)
   - Contains order execution logic
   - Updates portfolio holdings
   - Records transaction history

---

## Migration Guide (For Legacy Code)

If you encounter old code that doesn't follow this architecture:

### Refactoring Steps
1. **Identify violations**
   - `fetch()` in components? → Move to hook + ApiClient
   - Calculations in components? → Move to service
   - Inline interfaces? → Move to `src/types/`
   - Formatting in components? → Use `Formatters` service

2. **Extract to appropriate layer**
   - API call → Custom hook
   - Calculation → Service
   - Type definition → `src/types/`
   - Display logic → Keep in component

3. **Update imports**
   - Use `@/` path aliases
   - Import from barrel exports (`index.ts`)

4. **Test changes**
   - Verify data still loads
   - Check for TypeScript errors
   - Test user interactions

5. **Clean up**
   - Remove old code
   - Update related components
   - Document changes

---

## Key Principles (Summary)

1. **Separation of Concerns**
   - Components render UI
   - Hooks manage state & data fetching
   - Services contain business logic
   - API routes handle backend operations

2. **Type Safety**
   - Everything is typed
   - Interfaces in `src/types/`
   - No `any` types (except when absolutely necessary)

3. **Consistency**
   - Hooks always return `{ data, isLoading, error }`
   - API routes always return structured JSON
   - Naming conventions are followed

4. **Testability**
   - Services are pure & testable
   - Components are simple & focused
   - Business logic is isolated

5. **Financial Precision**
   - NEVER use native JavaScript arithmetic for money
   - ALWAYS use `FinancialMath` service
   - ALWAYS format with `Formatters` service

6. **Security**
   - Authentication on all protected routes
   - Authorization for admin operations
   - HttpOnly cookies for sessions
   - No secrets in client code

---

## Additional Resources

- **Next.js Docs:** https://nextjs.org/docs
- **Prisma Docs:** https://www.prisma.io/docs
- **Radix UI Docs:** https://www.radix-ui.com/docs/primitives
- **Tailwind CSS Docs:** https://tailwindcss.com/docs
- **Decimal.js Docs:** https://mikemcl.github.io/decimal.js/

---

## Questions & Updates

This architecture guide should be updated as the project evolves. If you encounter patterns not covered here or need clarification:

1. **Add to this document** - Update `.cursor/rules/architecture.mdc`
2. **Document in code** - Add comments for complex logic
3. **Update related rules** - Keep all `.mdc` files in sync

**Last Updated:** January 6, 2025
